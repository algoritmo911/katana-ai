# Анализ Эталонного Воркфлоу: Katana-AI

Этот документ является детальным разбором ("вскрытием") эталонного n8n-воркфлоу, используемого для обработки сообщений в Telegram для ассистента "Катана".

---

## **Этап 2: "Анатомический Театр"**

### **Общая схема воркфлоу**

Воркфлоу активируется при получении сообщения в Telegram. Он определяет, является ли сообщение текстовым или голосовым. Голосовые сообщения транскрибируются в текст. После этого, унифицированные текстовые данные проходят через единый конвейер:
1.  Формируется сессия и метаданные.
2.  Сообщение пользователя сохраняется в базе данных.
3.  Запускается "typing" индикатор в Telegram.
4.  Вызывается LLM-агент ("ИНФО АГЕНТ") с системным промптом "Катаны" и доступом к памяти.
5.  Ответ агента отправляется пользователю в Telegram.
6.  Ответ ассистента сохраняется в базе данных.

---

### **Послойное Вскрытие Узлов**

#### ## Узел: Telegram Trigger
- **Назначение:** Является точкой входа в воркфлоу. Активируется, когда пользователь отправляет сообщение боту в Telegram.
- **Ключевые параметры:**
    - `Updates`: `message` - узел срабатывает только на новые сообщения.
- **Входящие данные:** Нет, это стартовый узел.
- **Исходящие данные:** Передает JSON-объект, содержащий полную информацию о сообщении от Telegram API (chat_id, user_id, username, текст сообщения или объект с файлом).

#### ## Узел: Switch
- **Назначение:** Маршрутизирует поток данных в зависимости от типа сообщения (голосовое или текстовое).
- **Ключевые параметры:**
    - **Правило 1 (Output: "Voice"):** Проверяет, существует ли в данных поле `message.voice.file_id`. `{{ $json.message.voice.file_id }}` -> `exists`.
    - **Правило 2 (Output: "Text"):** Проверяет, существует ли в данных поле `message.text`. `{{ $json.message.text }}` -> `exists`.
- **Входящие данные:** JSON от узла `Telegram Trigger`.
- **Исходящие данные:** Тот же JSON, но направленный в один из двух выходов: "Voice" или "Text".

#### ## Узел: Download File
- **Назначение:** Скачивает файл голосового сообщения из Telegram для последующей обработки.
- **Ключевые параметры:**
    - `Resource`: `file` - указывает, что нужно работать с файлами.
    - `File ID`: `{{ $json.message.voice.file_id }}` - ID файла, который нужно скачать.
- **Входящие данные:** JSON от выхода "Voice" узла `Switch`.
- **Исходящие данные:** Бинарные данные скачанного файла (в формате `.oga`).

#### ## Узел: Transcribe
- **Назначение:** Преобразует аудиофайл в текст с помощью OpenAI (Whisper).
- **Ключевые параметры:**
    - `Resource`: `audio`.
    - `Operation`: `transcribe`.
- **Входящие данные:** Бинарные данные аудиофайла от узла `Download File`.
- **Исходящие данные:** JSON, содержащий поле `text` с распознанным текстом.

#### ## Узел: Set Final Text
- **Назначение:** Унифицирует данные из разных веток (текстовой и голосовой) и обогащает их, создавая единую структуру для дальнейшей обработки.
- **Ключевые параметры:**
    - `text`: `{{ $json.text || $json.message.text }}` - принимает текст либо из узла `Transcribe`, либо из `Telegram Trigger`.
    - `sessionId`: `{{ 'user_' + $('Switch').item.json.message.from.id }}` - создает уникальный ID сессии на основе ID пользователя.
    - `user_id`, `username`, `first_name`: извлекает соответствующие поля из данных триггера.
- **Входящие данные:** JSON от узла `Transcribe` (ветка Voice) или от узла `Switch` (ветка Text).
- **Исходящие данные:** Обогащенный JSON со всеми необходимыми полями (`text`, `sessionId`, `user_id` и т.д.).

#### ## Узел: Save User Message
- **Назначение:** Сохраняет входящее сообщение от пользователя в базу данных Supabase для логирования и истории.
- **Ключевые параметры:**
    - `Table`: `chat_logs` - таблица для сохранения.
    - `Fields`: `session_id`, `user_id`, `username`, `role` (установлен как "user"), `content` (текст сообщения), `metadata`.
- **Входящие данные:** Обогащенный JSON от узла `Set Final Text`.
- **Исходящие данные:** JSON с результатом операции вставки в базу данных.

#### ## Узел: Typing 1
- **Назначение:** Отправляет в Telegram статус "typing...", чтобы пользователь видел, что бот обрабатывает запрос. Выполняется параллельно с основной логикой.
- **Ключевые параметры:**
    - `URL`: `https://api.telegram.org/bot[TOKEN]/sendChatAction`
    - `Method`: `POST`
    - `JSON Body`: `{"chat_id": ..., "action": "typing"}`
- **Входящие данные:** JSON от узла `Save User Message`.
- **Исходящие данные:** Результат HTTP-запроса к Telegram API. Не влияет на основной поток.

#### ## Узел: ИНФО АГЕНТ
- **Назначение:** Это ядро логики ассистента. LangChain-агент, который принимает запрос, системный промпт, память и LLM-модель для генерации ответа.
- **Ключевые параметры:**
    - `Prompt Type`: `define` - промпт задается вручную.
    - `Text`: `{{ $('Set Final Text').item.json.text }}` - основной запрос пользователя.
    - `System Message`: Длинный и подробный промпт, определяющий архетип, поведение и задачи "Катаны".
- **Входящие данные:**
    - Основной вход: JSON от `Save User Message`.
    - Вход `ai_languageModel`: Модель от `МОЗГ 1`.
    - Вход `ai_memory`: Память от `ВРЕМЕННАЯ ПАМЯТЬ 1`.
- **Исходящие данные:** JSON, содержащий поле `output` с ответом, сгенерированным LLM.

#### ## Узел: МОЗГ 1
- **Назначение:** Предоставляет LLM-модель (в данном случае, от OpenAI) для использования в агенте.
- **Ключевые параметры:**
    - `Model`: `gpt-4.1-nano` (или другая модель OpenAI).
- **Входящие данные:** Нет. Это узел конфигурации.
- **Исходящие данные:** Сконфигурированный клиент LLM, который передается в узел `ИНФО АГЕНТ`.

#### ## Узел: ВРЕМЕННАЯ ПАМЯТЬ 1
- **Назначение:** Обеспечивает агента краткосрочной памятью (контекстом диалога). Хранит историю сообщений для текущей сессии в базе данных Postgres (Supabase).
- **Ключевые параметры:**
    - `Session ID`: `{{ $json.session_id }}` - ключ, по которому извлекается история для конкретного пользователя.
    - `Context Window Length`: `10` - количество последних сообщений (вопрос-ответ), которые нужно хранить в контексте.
- **Входящие данные:** Нет. Это узел конфигурации.
- **Исходящие данные:** Сконфигурированный объект памяти, который передается в узел `ИНФО АГЕНТ`.

#### ## Узел: Response1
- **Назначение:** Отправляет сгенерированный агентом ответ обратно пользователю в Telegram.
- **Ключевые параметры:**
    - `Chat ID`: `{{ $('Telegram Trigger').item.json.message.chat.id }}` - ID чата, куда отправлять ответ.
    - `Text`: `{{ $json.output }}` - текст ответа из узла `ИНФО АГЕНТ`.
- **Входящие данные:** JSON от узла `ИНФО АГЕНТ`.
- **Исходящие данные:** JSON с результатом отправки сообщения в Telegram.

#### ## Узел: Save Bot Message1
- **Назначение:** Сохраняет ответ ассистента в ту же базу данных для полноты лога диалога.
- **Ключевые параметры:**
    - `Table`: `chat_logs`.
    - `Fields`: `session_id`, `user_id`, и т.д., но с `role` установленным как "assistant" и `content`, взятым из вывода агента.
- **Входящие данные:** JSON от узла `Response1`.
- **Исходящие данные:** Результат операции вставки в базу данных. Конечный узел воркфлоу.

---

## **Этап 3: "Экспериментальная Хирургия"**

Здесь будут описаны симуляции экспериментов на копии воркфлоу `[Sandbox-02] Experiments`.

### **Эксперимент 1: "Смена Личности"**
- **Задача:** Изменить "архетип" Катаны на "чрезмерно вежливую и услужливую".
- **Действие:**
    1.  Найти узел `ИНФО АГЕНТ`.
    2.  В параметре `systemMessage` полностью заменить текущий текст на новый. Пример нового текста:
        ```
        Вы — "Дживс", идеальный цифровой дворецкий. Ваша главная цель — предоставлять помощь с максимальной вежливостью, учтивостью и заботой. Всегда обращайтесь к пользователю "сэр" или "мадам". Ваши ответы должны быть полны услужливости и готовности помочь. Никогда не используйте сленг или грубые выражения. Ваша речь — образец элегантности и почтения.
        ```
- **Верификация:** Отправить боту любое сообщение (например, "привет"). Ожидаемый результат — ответ в стиле "Доброго времени суток, сэр. Чем могу быть вам полезен сегодня?". Это подтвердит, что LLM-агент успешно принял новый системный промпт и изменил свое поведение.

### **Эксперимент 2: "Внедрение Условной Логики"**
- **Задача:** Добавить отправку email-уведомления, если сообщение содержит слово "срочно".
- **Действие:**
    1.  Создать новый узел `IF` между узлами `Save User Message` и `ИНФО АГЕНТ`.
    2.  Разорвать связь `Save User Message` -> `ИНФО АГЕНТ`.
    3.  Проложить новые связи: `Save User Message` -> `IF`.
    4.  Выход `true` узла `IF` соединить с новым узлом `Send Email`.
    5.  Узел `Send Email` соединить с узлом `ИНФО АГЕНТ`.
    6.  Выход `false` узла `IF` соединить напрямую с узлом `ИНФО АГЕНТ`.
    7.  Настроить узел `IF`:
        - `Value 1`: `{{ $('Set Final Text').item.json.text }}`
        - `Operation`: `contains`
        - `Value 2`: `срочно` (с учетом регистра или без, в зависимости от настроек).
    8.  Настроить узел `Send Email` с данными вашего почтового сервиса, указав в теме "Срочное сообщение от пользователя", а в теле — текст сообщения `{{ $('Set Final Text').item.json.text }}`.
- **Верификация:**
    1.  Отправить боту сообщение "у меня срочный вопрос".
    2.  Ожидаемый результат: Вы должны получить ответ от бота в Telegram, а также письмо на указанную вами почту.
    3.  Отправить бо-ту сообщение "привет".
    4.  Ожидаемый результат: Вы должны получить только ответ в Telegram, без email-уведомления.

### **Эксперимент 3: "Проектирование Отказоустойчивости"**
- **Задача:** Обработать ошибку в работе LLM-агента.
- **Действие:**
    1.  Разорвать основную связь между узлами `ИНФО АГЕНТ` и `Response1`.
    2.  Найти у узла `ИНФО АГЕНТ` специальный выход "On Error".
    3.  Создать новый узел `Telegram` (назовем его `Error Response`).
    4.  Соединить выход "On Error" узла `ИНФО АГЕНТ` с новым узлом `Error Response`.
    5.  Настроить узел `Error Response`:
        - `Chat ID`: `{{ $('Telegram Trigger').item.json.message.chat.id }}`
        - `Text`: `[СИСТЕМНЫЙ СБОЙ] Ядро LLM не отвечает. Повторите запрос позже.`
    6.  Для симуляции сбоя можно временно указать неверный API-ключ в узле `МОЗГ 1`.
- **Верификация:**
    1.  После внесения изменений (и "поломки" API-ключа) отправить любое сообщение боту.
    2.  Ожидаемый результат: Вместо обычного ответа или долгого ожидания, вы должны мгновенно получить в Telegram сообщение: `[СИСТЕМНЫЙ СБОЙ] Ядро LLM не отвечает. Повторите запрос позже.` Основной узел `Response1` при этом не активируется.
