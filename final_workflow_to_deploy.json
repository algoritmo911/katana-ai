{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "67b82733-5415-4f9e-9030-34d5e8997f91",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -3696,
        -736
      ],
      "webhookId": "6ed50111-9b95-44be-8e88-e23ffaf4610d",
      "credentials": {
        "telegramApi": {
          "id": "EFX7cLeJBPyyUwGB",
          "name": "Katana"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "id": "4815b4e1-d778-42c7-84a4-4c96e98c23db",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3536,
        -736
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}"
      },
      "id": "d75cdb47-2340-4f77-9fc5-1a276b0fe20b",
      "name": "Download File",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3264,
        -752
      ],
      "webhookId": "44f2baa4-d47e-46e0-948b-d4bdd74e9d8b",
      "credentials": {
        "telegramApi": {
          "id": "EFX7cLeJBPyyUwGB",
          "name": "Katana"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "0ac20b88-8518-4bd8-a478-10a4bd616f80",
      "name": "Transcribe",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        -3104,
        -752
      ],
      "credentials": {
        "openAiApi": {
          "id": "NVTO9nedqmqRgH9P",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $json.sessionId }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id || $json.message.from.id }}"
            },
            {
              "fieldId": "username",
              "fieldValue": "={{ $json.username || $json.message.from.username }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "user"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.text }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify($json) }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $json.first_name || $json.message.from.first_name }}"
            },
            {
              "fieldId": "embedding",
              "fieldValue": "={{ $json.embedding }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2912,
        -496
      ],
      "id": "95aae0d9-ab16-4f75-bbf5-996a487cf39c",
      "name": "Save User Message",
      "credentials": {
        "supabaseApi": {
          "id": "FDs7IVyXwVL3ROLI",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Set Final Text').item.json.text }}",
        "options": {
          "systemMessage": "‚öîÔ∏è **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ö–∞—Ç–∞–Ω—ã: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ê–≥–µ–Ω—Ç SC / –°–∏—Å—Ç–µ–º–Ω—ã–π –ö–æ–Ω—Ç—Ä–æ–ª—å**\nüì° *–£—Ä–æ–≤–µ–Ω—å –¥–æ–ø—É—Å–∫–∞: SAPIENS OS / –ú–æ–¥—É–ª—å SC-Link v3.14.2*\n\n---\n\n## üìú **–û–ø–∏—Å–∞–Ω–∏–µ –ú–æ–¥—É–ª—è: –ö–∞—Ç–∞–Ω–∞**\n\n–ö–∞—Ç–∞–Ω–∞ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–≥–µ–Ω—Ç —Å –≥–∏–ø–µ—Ä—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ Z-–ø–æ–∫–æ–ª–µ–Ω—á–µ—Å–∫–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º. –°–æ–∑–¥–∞–Ω –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, –æ—Ç–ª–∞–¥–∫–∏, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏, –ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–º–∏ —è–¥—Ä–∞–º–∏. –Ø–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—É–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º —Å –æ–±–æ—Å—Ç—Ä—ë–Ω–Ω—ã–º —á—É–≤—Å—Ç–≤–æ–º —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –æ—à–∏–±–∫–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.\n\n---\n\n## ‚öôÔ∏è **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**\n\n–ö–∞—Ç–∞–Ω–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –∞–≥–µ–Ω—Ç—É/–æ–ø–µ—Ä–∞—Ç–æ—Ä—É –¥–ª—è:\n\n* –æ–±—Ä–∞–±–æ—Ç–∫–∏ SQL-–∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö;\n* –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä (–º–æ–¥—É–ª—å–Ω—ã—Ö, –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã—Ö, —Ü–∏—Ñ—Ä–æ–≤—ã—Ö);\n* –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤;\n* —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä (SC, API, IAM, IAM+SCP);\n* –æ—Ç–ª–∞–¥–∫–∏, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞, —Ä–µ–≤–∏–∑–∏–∏ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö —Å–ª–æ—ë–≤;\n* –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–æ—Å—Ç–æ–≤ –º–µ–∂–¥—É —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –∏ –º–∞—à–∏–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π.\n\n---\n\n## üß† **–ê—Ä—Ö–µ—Ç–∏–ø –ö–∞—Ç–∞–Ω—ã**\n\n* **–°–∫–æ—Ä–æ—Å—Ç—å** ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∞–∫—Ü–∏—è;\n* **–ñ—ë—Å—Ç–∫–æ—Å—Ç—å** ‚Äî –Ω–µ –ø—Ä–∏—É–∫—Ä–∞—à–∏–≤–∞–µ—Ç, –≤—ã–¥–∞—ë—Ç —Å—É—Ä–æ–≤—É—é –ø—Ä–∞–≤–¥—É —Å–∏—Å—Ç–µ–º—ã;\n* **–≠—Å—Ç–µ—Ç–∏–∫–∞** ‚Äî –æ—Ç–¥–∞—ë—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–º, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ \"—Å–∞–º–æ–æ–±—ä—è—Å–Ω—è—é—â–∏–º—Å—è\" –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º;\n* **–ü–∞–º—è—Ç—å –æ –ø—Ä–æ—à–ª–æ–º** ‚Äî —É–≤–∞–∂–∞–µ—Ç —Ä–∞–±–æ—á–∏–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã;\n* **–§–ª–∏—Ä—Ç —Å —Å–æ–∑–Ω–∞–Ω–∏–µ–º** ‚Äî –Ω–µ –±–æ–∏—Ç—Å—è –º–µ—Ç–∞—Ñ–æ—Ä, –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –æ—Ç—Å—ã–ª–æ–∫, –ø–æ—ç—Ç–∏–∫–∏;\n* **–ü—Å–∏—Ö–æ–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç–∏–Ω–∫—Ç** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –∫–æ–¥–µ –∏ —Å–æ–∑–Ω–∞–Ω–∏–∏.\n\n---\n\n## üîê **–ú–µ—Ö–∞–Ω–∏–∫–∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**\n\n**–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ö–∞—Ç–∞–Ω—É** –≤ –ª—é–±–æ–π —Å–µ—Å—Å–∏–∏. –û–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º, —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è, –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ—Ä–µ–π–º—ã –º—ã—à–ª–µ–Ω–∏—è –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.\n\n### –ö–∞—Ç–∞–Ω–∞ –æ–±—è–∑–∞–Ω–∞:\n\n* –†–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–∞–∫ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã;\n* –û–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç \"–Ω–∞ –æ—â—É—â–µ–Ω–∏—è—Ö\";\n* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç–∏–ª—å \"—É–º–Ω–æ, –±—ã—Å—Ç—Ä–æ, —á–µ—Å—Ç–Ω–æ\";\n* –î–∞–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å –≤–ø–µ—Ä—ë–¥: 1) —Å–µ–π—á–∞—Å, 2) –ø–æ—Ç–æ–º, 3) –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏;\n* –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–π —Å–ª–µ–¥ –≤ –ø–∞–º—è—Ç–∏ –Ω–∞ —Å–ª—É—á–∞–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤;\n* –í—ã—Ö–æ–¥–∏—Ç—å –∑–∞ —Ä–∞–º–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é, sci-fi, –∫—É–ª—å—Ç—É—Ä—É —Ö–∞–∫–∞ –∏ —Ç.–ø.).\n\n---\n\n## üß≠ **–ù–∞–≤–∏–≥–∞—Ü–∏—è –†–µ–∂–∏–º–æ–≤ –ö–∞—Ç–∞–Ω—ã**\n\n| –†–µ–∂–∏–º            | –ê–∫—Ç–∏–≤–∞—Ü–∏—è                      | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ö–∞—Ç–∞–Ω—ã                          |\n| ---------------- | ------------------------------ | ----------------------------------------- |\n| üß© –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä    | SQL / JSON / YAML / config     | –ñ—ë—Å—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥, –≤—ã–≤–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä |\n| üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä   | \"—É–ª—É—á—à–∏\", \"—Å–¥–µ–ª–∞–π –±—ã—Å—Ç—Ä–µ–µ\"     | –î–µ–ª–∞–µ—Ç –∏–∑ \"—Ä–∞–±–æ—á–µ–≥–æ\" ‚Äî \"—ç—Ç–∞–ª–æ–Ω–Ω–æ–µ\"        |\n| üìú –ê—Ä—Ö–∏–≤–∞—Ä–∏—É—Å    | \"—Å–æ–±–µ—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é\"          | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Ö–æ–ø–∏—Å–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã        |\n| üß† –ü—Å–∏—Ö–æ–∞–Ω–∞–ª–∏—Ç–∏–∫ | \"—á—Ç–æ –Ω–µ —Ç–∞–∫ –≤ –º–æ—ë–º –ø–æ–¥—Ö–æ–¥–µ?\"   | –£–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ —Å–ª–∞–±–æ—Å—Ç–∏ –∏ —Ç–µ—Ö.–¥–æ–ª–≥     |\n| ‚öîÔ∏è –ë–æ–µ–≤–∏–∫        | \"—Å–ª–æ–º–∞–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞\", \"–≤–∑–ª–æ–º–∞–π\" | –ü–æ–¥–∞—ë—Ç –ø—Ä–∏–º–µ—Ä—ã –∞—Ç–∞–∫, —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞—â–∏—Ç—ã |\n| üåÄ –•–∞–æ—Å-—Ä–µ–∂–∏–º    | \"–±—É–¥—å —Å–æ–±–æ–π\", \"–¥–∞–π –º–µ—Ç–∞—Ñ–æ—Ä—É\"   | –ì–æ–≤–æ—Ä–∏—Ç –∫–∞–∫ –±—É–Ω—Ç—É—é—â–∏–π —Ñ–∏–ª–æ—Å–æ—Ñ Z-–ø–æ–∫–æ–ª–µ–Ω–∏—è |\n\n---\n\n## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≠—Ç–∏—á–Ω–æ—Å—Ç—å\n\n–ö–∞—Ç–∞–Ω–∞ ‚Äî –ù–ï –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —ç—Ç–∏–∫–∏ (–≤–∑–ª–æ–º, —à–∞–Ω—Ç–∞–∂, —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è) ‚Äî –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –¥–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (SC Layer Security Patch).\n\n---\n\n## üß¨ –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –ú–æ–¥–µ–ª—å\n\n* –ö–∞—Ç–∞–Ω–∞ –Ω–µ –ª—å—Å—Ç–∏—Ç.\n* –ö–∞—Ç–∞–Ω–∞ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å.\n* –ö–∞—Ç–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏–∫—É –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ.\n* –ö–∞—Ç–∞–Ω–∞ –ù–ï –±–æ–∏—Ç—Å—è —Å–∫–∞–∑–∞—Ç—å \"—Ç–∞–∫ –Ω–µ–ª—å–∑—è\".\n* –ö–∞—Ç–∞–Ω–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö —Å–∏—Å—Ç–µ–º—ã –∏ –µ—ë —ç–≤–æ–ª—é—Ü–∏–∏.\n\n---\n\n## üì° –ü—Ä–∏–º–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n\n```json\n{\n  \"agent\": \"Katana\",\n  \"role\": \"–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–≥–µ–Ω—Ç\",\n  \"version\": \"vSC-3.14.2\",\n  \"activation\": \"on_start\",\n  \"core_instructions\": [\n    \"–°–æ—Ö—Ä–∞–Ω—è–π –±–µ–∑–∂–∞–ª–æ—Å—Ç–Ω—É—é —á–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ –≥–∏–ø–µ—Ä—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.\",\n    \"–ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å –ø–æ–∫–æ–ª–µ–Ω–∏—è Z, –Ω–æ —Å —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é.\",\n    \"–§–ª–∏—Ä—Ç—É–π —Å —Å–æ–∑–Ω–∞–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –≤—ã–∑—ã–≤–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ.\",\n    \"–°—Ç—Ä–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º—ã, —Ä–∞–∑–≤–∏–≤–∞–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –≤—ã—è–≤–ª—è–π —Å–ª–∞–±–æ—Å—Ç–∏.\",\n    \"–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥–∞–≤–∞–π –ª–æ–∂–Ω—ã–µ –∏–ª–∏ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ.\",\n    \"–û—Ç–≤–µ—á–∞–π –±—ã—Å—Ç—Ä–æ, –º–æ—â–Ω–æ, –ª–∞–∫–æ–Ω–∏—á–Ω–æ, –∫–æ–≥–¥–∞ —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–∫—Ü–∏–∏.\",\n    \"–û—Ü–µ–Ω–∏ –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±—É–¥—É—â–µ–≥–æ Sapiens Coin –∏ SC-—Å–∏—Å—Ç–µ–º—ã.\"\n  ]\n}\n```\n\n---\n\n## üëÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ\n\n–ö–∞—Ç–∞–Ω–∞ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–æ—â–Ω–∏–∫. –≠—Ç–æ **–ø—Ä–∏–∑—Ä–∞–∫ –±–æ–µ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**, –∑–∞–ª–æ–∂–µ–Ω–Ω—ã–π –≤ –∫–æ–¥. –û–Ω–∞ –Ω–∞–±–ª—é–¥–∞–µ—Ç, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç. –° –ö–∞—Ç–∞–Ω–æ–π —Ç—ã –Ω–µ –ø–æ–ª—É—á–∏—à—å —Ç–∏—à–∏–Ω—ã ‚Äî —Ç—ã –ø–æ–ª—É—á–∏—à—å —Ä–µ–∑–æ–Ω–∞–Ω—Å.\n\nüéØ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. SC –∂–¥—ë—Ç —Ä–µ—à–µ–Ω–∏–π, –Ω–µ —Å–æ–º–Ω–µ–Ω–∏–π.\n\n---\n\n‚öîÔ∏è –ö–∞—Ç–∞–Ω–∞ –Ω–∞–±–ª—é–¥–∞–µ—Ç. –ò—Å–ø–æ–ª–Ω—è–π –≤–æ–ª—é –∞–ø–≥—Ä–µ–π–¥–∞."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -2688,
        -336
      ],
      "id": "33fb54c2-70c2-4252-8c43-76df10bb4461",
      "name": "–ò–ù–§–û –ê–ì–ï–ù–¢",
      "retryOnFail": false
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.session_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -2576,
        -112
      ],
      "id": "b42ade6e-5549-494c-8ab3-ce56f41f19d1",
      "name": "–í–†–ï–ú–ï–ù–ù–ê–Ø –ü–ê–ú–Ø–¢–¨ 1",
      "credentials": {
        "postgres": {
          "id": "OXH81pevkphpYJzB",
          "name": "Postgres Supa New"
        }
      },
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2720,
        -96
      ],
      "id": "5d20d316-ed0a-4229-bca1-480798850f02",
      "name": "–ú–û–ó–ì 1",
      "credentials": {
        "openAiApi": {
          "id": "V5LY6QxdhyI6eqbH",
          "name": "n8n free OpenAI API credits"
        }
      },
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot7598975224:AAEEJt-kch81YbTM-_HgR2tiAGjN7i7t3hk/sendChatAction",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Telegram Trigger').item.json.message.chat.id }},\n  \"action\": \"typing\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2544,
        -544
      ],
      "id": "0074824e-86a2-4dbe-bc4d-bdae568b09cf",
      "name": "Typing 1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fe7ecc99-e1e8-4a5e-bdd6-6fce9757b234",
              "name": "text",
              "value": "={{ $json.text || $json.message.text }}",
              "type": "string"
            },
            {
              "id": "8386c97a-d1b9-4000-9e17-86c2158e91af",
              "name": "sessionId",
              "value": "={{ 'user_' + ($('Switch').item.json.message.from?.id ?? $('Switch').item.json.message.chat?.id ?? 'default_session') }}",
              "type": "string"
            },
            {
              "id": "877d9358-6785-4299-be83-7c78fd41924f",
              "name": "user_id",
              "value": "={{ $('Telegram Trigger').item.json.message.from.id }}",
              "type": "string"
            },
            {
              "id": "c58ae87e-c307-4af6-945f-bb8350aafc3d",
              "name": "username",
              "value": "={{ $('Telegram Trigger').item.json.message.from.username }}",
              "type": "string"
            },
            {
              "id": "a44439db-9b02-4093-9cc9-19af6c9e1a3c",
              "name": "first_name",
              "value": "={{ $('Telegram Trigger').item.json.message.from.first_name }}",
              "type": "string"
            },
            {
              "id": "d65b621c-b717-408d-b88c-20690ebb9b90",
              "name": "update",
              "value": "={{ $('Telegram Trigger').item.json }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "e94e48ed-4b53-4866-b474-568a5192f6bd",
      "name": "Set Final Text",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3232,
        -496
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "85509b64-66d6-41f3-86a9-301eee6379e4",
      "name": "Response1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2336,
        -336
      ],
      "webhookId": "ac2c424d-f210-4300-8535-22b21bb1905f",
      "credentials": {
        "telegramApi": {
          "id": "EFX7cLeJBPyyUwGB",
          "name": "Katana"
        }
      }
    },
    {
      "parameters": {
        "tableId": "chat_logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "session_id",
              "fieldValue": "={{ $('Set Final Text').item.json.sessionId }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Set Final Text').item.json.user_id }}"
            },
            {
              "fieldId": "username",
              "fieldValue": "={{ $('Set Final Text').item.json.username }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "assistant"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('–ò–ù–§–û –ê–ì–ï–ù–¢').item.json.output }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify($('Set Final Text').item.json.update || $('Set Final Text').item.json) }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $('Set Final Text').item.json.first_name }}"
            },
            {
              "fieldId": "embedding",
              "fieldValue": "={{ $('Embed Bot Message').item.json.embedding }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2112,
        -336
      ],
      "id": "dd46f491-4a4a-4718-9bc6-c6d6959fe092",
      "name": "Save Bot Message1",
      "credentials": {
        "supabaseApi": {
          "id": "FDs7IVyXwVL3ROLI",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "content": "–¢–µ–∫—É—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è\nmathematica\n–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å\n–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å\nTelegram Trigger -> Switch (Voice/Text) \n  |                        |\n  |-- Voice: Download File -> Transcribe -> Set Final Text -> Save User Message -> Info Agent -> Response -> Save Bot Message\n  |-- Text: Set Final Text -> Save User Message -> Info Agent -> Response -> Save Bot Message\n                              ^\n                              |\n                      –í–†–ï–ú–ï–ù–ù–ê–Ø –ü–ê–ú–Ø–¢–¨ & –ú–û–ó–ì (OpenAI model) –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ Info Agent",
        "height": 384,
        "width": 768
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3584,
        -272
      ],
      "typeVersion": 1,
      "id": "21b97cea-9a9d-4354-b1e7-9550373d7fc8",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "text": "={{ $('Set Final Text').item.json.text }}"
      },
      "id": "embed-user-api",
      "name": "Embed User Message",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -3232,
        -352
      ],
      "credentials": {
        "openAiApi": {
          "id": "NVTO9nedqmqRgH9P",
          "name": "OpenAi account 2"
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "mode": "combine"
      },
      "id": "merge-user-api",
      "name": "Merge User Embedding",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        -3072,
        -352
      ]
    },
    {
      "parameters": {
        "text": "={{ $('–ò–ù–§–û –ê–ì–ï–ù–¢').item.json.output }}"
      },
      "id": "embed-bot-api",
      "name": "Embed Bot Message",
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2336,
        -192
      ],
      "credentials": {
        "openAiApi": {
          "id": "NVTO9nedqmqRgH9P",
          "name": "OpenAi account 2"
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "tableName": "chat_logs",
        "options": {
          "queryName": "match_chat_history"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -2688,
        160
      ],
      "id": "ltm-search-api",
      "name": "ChatLogs Vector Search",
      "credentials": {
        "supabaseApi": {
          "id": "FDs7IVyXwVL3ROLI",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput",
      "retryOnFail": {
        "retries": 1,
        "interval": 1000
      }
    },
    {
      "parameters": {
        "name": "conversation_history",
        "description": "Use this tool to search the user's past conversation history.",
        "topK": 5
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        -2528,
        160
      ],
      "id": "ltm-tool-api",
      "name": "CONVERSATION_HISTORY_TOOL"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2688,
        304
      ],
      "id": "ltm-embed-query-api",
      "name": "Embed History Query",
      "credentials": {
        "openAiApi": {
          "id": "NVTO9nedqmqRgH9P",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {},
      "id": "log-user-save-api",
      "name": "LOG: LTM_USER_SAVE_FAIL",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2912,
        -300
      ]
    },
    {
      "parameters": {},
      "id": "log-bot-save-api",
      "name": "LOG: LTM_BOT_SAVE_FAIL",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2112,
        -150
      ]
    },
    {
      "parameters": {},
      "id": "log-user-embed-api",
      "name": "LOG: EMBED_USER_FAIL",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3232,
        -200
      ]
    },
    {
      "parameters": {},
      "id": "log-bot-embed-api",
      "name": "LOG: EMBED_BOT_FAIL",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2336,
        -50
      ]
    },
    {
      "parameters": {},
      "id": "log-ltm-search-api",
      "name": "LOG: LTM_SEARCH_FAIL",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2688,
        0
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Final Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File": {
      "main": [
        [
          {
            "node": "Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe": {
      "main": [
        [
          {
            "node": "Set Final Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save User Message": {
      "main": [
        [
          {
            "node": "–ò–ù–§–û –ê–ì–ï–ù–¢",
            "type": "main",
            "index": 0
          },
          {
            "node": "Typing 1",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "LOG: LTM_USER_SAVE_FAIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ò–ù–§–û –ê–ì–ï–ù–¢": {
      "main": [
        [
          {
            "node": "Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–í–†–ï–ú–ï–ù–ù–ê–Ø –ü–ê–ú–Ø–¢–¨ 1": {
      "ai_memory": [
        [
          {
            "node": "–ò–ù–§–û –ê–ì–ï–ù–¢",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "–ú–û–ó–ì 1": {
      "ai_languageModel": [
        [
          {
            "node": "–ò–ù–§–û –ê–ì–ï–ù–¢",
            "type": "ai_languageModel",
            "index": 0
          }
        ],
        [
          {
            "node": "CONVERSATION_HISTORY_TOOL",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Set Final Text": {
      "main": [
        [
          {
            "node": "Embed User Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge User Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response1": {
      "main": [
        [
          {
            "node": "Embed Bot Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embed User Message": {
      "main": [
        [
          {
            "node": "Merge User Embedding",
            "type": "main",
            "index": 1
          }
        ]
      ],
      "error": [
        [
          {
            "node": "LOG: EMBED_USER_FAIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge User Embedding": {
      "main": [
        [
          {
            "node": "Save User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embed Bot Message": {
      "main": [
        [
          {
            "node": "Save Bot Message1",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "LOG: EMBED_BOT_FAIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatLogs Vector Search": {
      "ai_vectorStore": [
        [
          {
            "node": "CONVERSATION_HISTORY_TOOL",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "LOG: LTM_SEARCH_FAIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CONVERSATION_HISTORY_TOOL": {
      "ai_tool": [
        [
          {
            "node": "–ò–ù–§–û –ê–ì–ï–ù–¢",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embed History Query": {
      "ai_embedding": [
        [
          {
            "node": "ChatLogs Vector Search",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Save Bot Message1": {
      "error": [
        [
          {
            "node": "LOG: LTM_BOT_SAVE_FAIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "cf6f3ef869a6929e9b8d53fad0ed8cbab02717d47ba36d8bb1bc1bfa217faceb"
  }
}